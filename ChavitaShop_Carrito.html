<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carrito - ChavitaShop</title>
  <style>
    /* [Mantén los mismos estilos que antes] */
  </style>
</head>
<body>
  <div id="carrito-container">
    <h1>🛒 Tu Carrito de Compras</h1>
    <div id="lista-carrito">
      <div class="carrito-vacio">
        <p>Tu carrito está vacío</p>
      </div>
    </div>
    <div id="total-carrito">Total: $0.00</div>
  </div>

  <script>
    // 1. Estado inicial del carrito
    let carrito = JSON.parse(localStorage.getItem('carrito-chavita')) || [];
    
    // 2. Función para actualizar la visualización
    function actualizarCarrito() {
      const lista = document.getElementById('lista-carrito');
      const totalElement = document.getElementById('total-carrito');
      
      if (carrito.length === 0) {
        lista.innerHTML = '<div class="carrito-vacio"><p>Tu carrito está vacío</p></div>';
        totalElement.textContent = 'Total: $0.00';
        localStorage.setItem('carrito-chavita', JSON.stringify([]));
        return;
      }
      
      let html = '';
      let total = 0;
      
      carrito.forEach(item => {
        const subtotal = item.precio * (item.cantidad || 1);
        html += `
          <div class="item-carrito">
            <img src="${item.imagen}" class="item-imagen">
            <div class="item-info">
              <div class="item-nombre">${item.nombre}</div>
              <div>$${item.precio.toFixed(2)} x ${item.cantidad || 1}</div>
              <div>Subtotal: $${subtotal.toFixed(2)}</div>
            </div>
          </div>
        `;
        total += subtotal;
      });
      
      lista.innerHTML = html;
      totalElement.textContent = `Total: $${total.toFixed(2)}`;
      localStorage.setItem('carrito-chavita', JSON.stringify(carrito));
    }
    
    // 3. Escuchar mensajes para agregar productos
    window.addEventListener('message', function(event) {
      console.log('Mensaje recibido:', event.data);
      
      // IMPORTANTE: En producción, verifica event.origin para seguridad
      // if (event.origin !== "https://tudominio.com") return;
      
      if (event.data.action === 'agregar-producto') {
        const producto = event.data.producto;
        console.log('Producto recibido:', producto);
        
        // Buscar si el producto ya existe
        const existente = carrito.find(p => p.id === producto.id);
        
        if (existente) {
          existente.cantidad = (existente.cantidad || 1) + 1;
        } else {
          producto.cantidad = 1;
          carrito.push(producto);
        }
        
        localStorage.setItem('carrito-chavita', JSON.stringify(carrito));
        actualizarCarrito();
      }
    });

    // 4. Sincronización al cargar y entre pestañas
    window.addEventListener('DOMContentLoaded', actualizarCarrito);
    
    window.addEventListener('storage', function(e) {
      if (e.key === 'carrito-chavita') {
        carrito = JSON.parse(e.newValue) || [];
        actualizarCarrito();
      }
    });

    // 5. Inicializar
    actualizarCarrito();
  </script>
</body>
</html>
