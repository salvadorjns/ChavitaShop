<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carrito - ChavitaShop</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #fff5f9;
    }
    #carrito-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .item-carrito {
      display: flex;
      align-items: center;
      padding: 15px;
      margin-bottom: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .item-imagen {
      width: 80px;
      height: 80px;
      object-fit: cover;
      margin-right: 15px;
      border-radius: 4px;
    }
    .item-info {
      flex-grow: 1;
    }
    .item-nombre {
      font-weight: bold;
      color: #e83e8c;
      margin-bottom: 5px;
    }
    .carrito-vacio {
      text-align: center;
      padding: 40px 20px;
      color: #888;
    }
    #total-carrito {
      font-weight: bold;
      font-size: 1.2em;
      text-align: right;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div id="carrito-container">
    <h1>游 Tu Carrito de Compras</h1>
    <div id="lista-carrito">
      <div class="carrito-vacio">
        <p>Tu carrito est치 vac칤o</p>
      </div>
    </div>
    <div id="total-carrito">Total: $0.00</div>
  </div>

  <script>
    // 1. Estado inicial del carrito
    let carrito = JSON.parse(localStorage.getItem('carrito-chavita')) || [];
    
    // 2. Funci칩n para actualizar la visualizaci칩n
    function actualizarCarrito() {
      const lista = document.getElementById('lista-carrito');
      const totalElement = document.getElementById('total-carrito');
      
      if (carrito.length === 0) {
        lista.innerHTML = '<div class="carrito-vacio"><p>Tu carrito est치 vac칤o</p></div>';
        totalElement.textContent = 'Total: $0.00';
        return;
      }
      
      // Generar HTML de los productos
      let html = '';
      let total = 0;
      
      carrito.forEach(item => {
        const subtotal = item.precio * (item.cantidad || 1);
        html += `
          <div class="item-carrito">
            <img src="${item.imagen}" class="item-imagen">
            <div class="item-info">
              <div class="item-nombre">${item.nombre}</div>
              <div>$${item.precio.toFixed(2)} x ${item.cantidad || 1}</div>
              <div>Subtotal: $${subtotal.toFixed(2)}</div>
            </div>
          </div>
        `;
        total += subtotal;
      });
      
      lista.innerHTML = html;
      totalElement.textContent = `Total: $${total.toFixed(2)}`;
      
      // Guardar en localStorage
      localStorage.setItem('carrito-chavita', JSON.stringify(carrito));
    }
    
    // 3. Escuchar mensajes para agregar productos (versi칩n modificada)
    window.addEventListener('message', function(event) {
      // Para desarrollo, aceptamos mensajes de cualquier origen ('*')
      // En producci칩n deber칤as especificar tus dominios seguros
      if (event.data.action === 'agregar-producto') {
        const producto = event.data.producto;
        
        let carrito = JSON.parse(localStorage.getItem('carrito-chavita')) || [];
        
        const existente = carrito.find(p => p.id === producto.id);
        if (existente) {
          existente.cantidad = (existente.cantidad || 1) + 1;
        } else {
          producto.cantidad = 1;
          carrito.push(producto);
        }
        
        localStorage.setItem('carrito-chavita', JSON.stringify(carrito));
        actualizarCarrito();
      }
    });

    // 4. Sincronizaci칩n al cargar (nueva funcionalidad)
    window.addEventListener('DOMContentLoaded', () => {
      // Sincronizar con localStorage al cargar
      actualizarCarrito();
      
      // Escuchar cambios en localStorage desde otras pesta침as
      window.addEventListener('storage', (e) => {
        if (e.key === 'carrito-chavita') {
          carrito = JSON.parse(e.newValue) || [];
          actualizarCarrito();
        }
      });
    });

    // 5. Inicializar al cargar (compatibilidad)
    actualizarCarrito();
  </script>
</body>
</html>
